<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test New Visit Recording</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .recording { background-color: #dc3545; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ New Visit Recording Architecture Test</h1>
        
        <div class="status info">
            <strong>Testing Status:</strong> Ready to test the new simplified recording system
        </div>

        <div id="browserSupport" class="status"></div>
        
        <div style="margin: 20px 0;">
            <button id="recordBtn" onclick="toggleRecording()">üé§ Start Recording</button>
            <button id="testMicBtn" onclick="testMicrophone()">üîß Test Microphone</button>
            <button id="clearBtn" onclick="clearResults()">üóëÔ∏è Clear</button>
        </div>

        <div id="recordingStatus" style="display: none;" class="status warning">
            <strong>üî¥ Recording...</strong> <span id="duration">00:00</span>
            <br><small>Speak clearly about a medical visit. Click "Stop Recording" when finished.</small>
        </div>

        <div id="results" style="display: none;">
            <h3>üìù Recording Results</h3>
            <div id="audioInfo" class="status info"></div>
            <div id="transcription" class="status success" style="display: none;"></div>
        </div>

        <div id="log" class="log">
            <strong>üìã Test Log:</strong><br>
            Initializing new visit recording architecture test...<br>
        </div>
    </div>

    <script>
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let startTime = null;
        let durationInterval = null;

        // Log function
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Check browser support
        function checkBrowserSupport() {
            const supportDiv = document.getElementById('browserSupport');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                supportDiv.className = 'status error';
                supportDiv.innerHTML = '‚ùå <strong>Not Supported:</strong> Your browser does not support audio recording';
                log('‚ùå Browser does not support getUserMedia');
                return false;
            }
            
            if (typeof MediaRecorder === 'undefined') {
                supportDiv.className = 'status error';
                supportDiv.innerHTML = '‚ùå <strong>Not Supported:</strong> Your browser does not support MediaRecorder';
                log('‚ùå Browser does not support MediaRecorder');
                return false;
            }
            
            supportDiv.className = 'status success';
            supportDiv.innerHTML = '‚úÖ <strong>Supported:</strong> Your browser supports the new recording architecture';
            log('‚úÖ Browser supports new recording architecture');
            return true;
        }

        // Test microphone access
        async function testMicrophone() {
            log('üîß Testing microphone access...');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('‚úÖ Microphone access granted');
                
                // Stop the test stream
                stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('browserSupport').className = 'status success';
                document.getElementById('browserSupport').innerHTML = '‚úÖ <strong>Ready:</strong> Microphone access granted, ready to record';
                
            } catch (error) {
                log('‚ùå Microphone access denied: ' + error.message);
                document.getElementById('browserSupport').className = 'status error';
                document.getElementById('browserSupport').innerHTML = '‚ùå <strong>Access Denied:</strong> Please allow microphone access';
            }
        }

        // Toggle recording
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        // Start recording
        async function startRecording() {
            try {
                log('üé§ Starting recording...');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000
                    }
                });

                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 64000
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        log(`üì¶ Audio chunk collected: ${event.data.size} bytes`);
                    }
                };

                mediaRecorder.onstop = () => {
                    processRecording();
                };

                mediaRecorder.onerror = (event) => {
                    log('‚ùå MediaRecorder error: ' + event.error);
                };

                mediaRecorder.start(1000); // 1-second chunks
                isRecording = true;
                startTime = Date.now();

                // Update UI
                document.getElementById('recordBtn').textContent = '‚èπÔ∏è Stop Recording';
                document.getElementById('recordBtn').className = 'recording';
                document.getElementById('recordingStatus').style.display = 'block';
                document.getElementById('results').style.display = 'none';

                // Start duration timer
                durationInterval = setInterval(updateDuration, 1000);
                
                log('‚úÖ Recording started successfully');

            } catch (error) {
                log('‚ùå Failed to start recording: ' + error.message);
                isRecording = false;
            }
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                log('‚èπÔ∏è Stopping recording...');
                mediaRecorder.stop();
                isRecording = false;

                // Stop duration timer
                if (durationInterval) {
                    clearInterval(durationInterval);
                    durationInterval = null;
                }

                // Update UI
                document.getElementById('recordBtn').textContent = 'üé§ Start Recording';
                document.getElementById('recordBtn').className = '';
                document.getElementById('recordingStatus').style.display = 'none';
            }
        }

        // Update duration display
        function updateDuration() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('duration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Process recording
        function processRecording() {
            log('üîÑ Processing recording...');
            
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            
            // Show audio info
            const audioInfo = document.getElementById('audioInfo');
            audioInfo.innerHTML = `
                <strong>üìä Audio Information:</strong><br>
                Size: ${Math.round(audioBlob.size / 1024)} KB<br>
                Type: ${audioBlob.type}<br>
                Duration: ${document.getElementById('duration').textContent}<br>
                Chunks: ${audioChunks.length}
            `;
            
            document.getElementById('results').style.display = 'block';
            
            log(`‚úÖ Audio blob created: ${audioBlob.size} bytes, ${audioChunks.length} chunks`);
            log('üéâ NEW ARCHITECTURE: Recording completed successfully!');
            log('üìù Next: This would be uploaded to Firebase Storage and processed by Cloud Functions');
            log('ü§ñ The new system will automatically transcribe and summarize the audio');
            
            // Simulate the new workflow
            simulateNewWorkflow(audioBlob);
        }

        // Simulate the new workflow
        function simulateNewWorkflow(audioBlob) {
            log('üîÑ SIMULATING NEW WORKFLOW:');
            log('1. ‚úÖ Upload to Firebase Storage: patient-visits/{uid}/{visitId}/raw.webm');
            log('2. ‚úÖ Cloud Function trigger: processVisitUpload');
            log('3. ‚úÖ Pub/Sub message: transcribe-request');
            log('4. ‚úÖ Speech-to-Text worker: Google STT v2 with medical context');
            log('5. ‚úÖ Pub/Sub message: summarize-request');
            log('6. ‚úÖ AI summarization worker: Google AI with medical prompts');
            log('7. ‚úÖ Firestore update: status="ready", results populated');
            log('8. ‚úÖ Real-time UI update: User sees transcription and summary');
            
            // Show simulated transcription
            setTimeout(() => {
                const transcriptionDiv = document.getElementById('transcription');
                transcriptionDiv.innerHTML = `
                    <strong>ü§ñ Simulated AI Results:</strong><br>
                    <strong>Transcript:</strong> "Patient visited for routine checkup. Blood pressure is 120 over 80, which is normal. Continue current medications including Lisinopril 10mg once daily. Schedule follow-up appointment in 3 months."<br><br>
                    <strong>Key Points:</strong><br>
                    ‚Ä¢ Routine checkup completed<br>
                    ‚Ä¢ Blood pressure normal (120/80)<br>
                    ‚Ä¢ Continue current medications<br><br>
                    <strong>Action Items:</strong><br>
                    ‚Ä¢ Schedule follow-up in 3 months<br>
                    ‚Ä¢ Continue Lisinopril 10mg daily<br><br>
                    <strong>Urgency:</strong> Low
                `;
                transcriptionDiv.style.display = 'block';
                log('üéâ SIMULATION COMPLETE: New architecture would provide rich, structured results!');
            }, 2000);
        }

        // Clear results
        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('log').innerHTML = '<strong>üìã Test Log:</strong><br>Cleared results, ready for new test...<br>';
        }

        // Initialize on page load
        window.onload = function() {
            log('üöÄ Initializing new visit recording architecture test...');
            
            if (checkBrowserSupport()) {
                log('‚úÖ Browser compatibility check passed');
                log('üí° Click "Test Microphone" to verify microphone access');
                log('üí° Click "Start Recording" to test the new simplified recording flow');
            } else {
                log('‚ùå Browser compatibility check failed');
            }
        };
    </script>
</body>
</html>