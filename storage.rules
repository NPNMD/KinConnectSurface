rules_version = '2';

// Firebase Storage Security Rules
service firebase.storage {
  match /b/{bucket}/o {
    
    // Patient visit recordings
    match /patient-visits/{userId}/{visitId}/{file} {
      // Allow read/write for the authenticated user who owns the visit
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow read access for family members with proper access
      allow read: if request.auth != null &&
        exists(/databases/(default)/documents/family-access/$(request.auth.uid + '_' + userId));
      
      // Validate file uploads
      allow write: if request.auth != null &&
        request.auth.uid == userId &&
        validateVisitFile(file, resource);
    }
    
    // Insurance card images
    match /patient-insurance-cards/{patientId}/{insuranceId}/{imageFile} {
      // Allow read if user owns the patient record or has family access
      allow read: if request.auth != null && (
        request.auth.uid == patientId ||
        exists(/databases/(default)/documents/family_calendar_access/$(request.auth.uid + '_' + patientId))
      );
      
      // Allow write only by the patient
      allow write: if request.auth != null &&
        request.auth.uid == patientId &&
        // Validate file type (images only)
        request.resource.contentType.matches('image/.*') &&
        // Limit file size to 10MB
        request.resource.size < 10 * 1024 * 1024;
    }
    
    // Helper function to validate visit file uploads
    function validateVisitFile(filename, resource) {
      // Check file size limits
      let maxSize = filename == 'raw.webm' ? 100 * 1024 * 1024 : 10 * 1024 * 1024; // 100MB for audio, 10MB for others
      
      // Check allowed file types
      let allowedFiles = ['raw.webm', 'transcript.json', 'transcript.txt', 'summary.json', 'summary.md', 'summary.mp3'];
      
      return request.resource.size <= maxSize &&
             filename in allowedFiles &&
             (resource == null || request.resource.size != resource.size); // Prevent overwrite unless size changed
    }
    
    // Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}